"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.verify = verify;
const has_encapsulation_violations_1 = require("../checks/has-encapsulation-violations");
const traverse_file_info_1 = require("../modules/traverse-file-info");
const check_for_dependency_rule_violation_1 = require("../checks/check-for-dependency-rule-violation");
const getFs_1 = __importDefault(require("../fs/getFs"));
const cli_1 = require("./cli");
const get_entry_from_cli_or_config_1 = require("./internal/get-entry-from-cli-or-config");
const log_info_for_missing_sheriff_config_1 = require("./internal/log-info-for-missing-sheriff-config");
function verify(args) {
    let deepImportsCount = 0;
    let dependencyRulesCount = 0;
    let filesCount = 0;
    let hasError = false;
    const validationsMap = {};
    const fs = (0, getFs_1.default)();
    const projectInfo = (0, get_entry_from_cli_or_config_1.getEntryFromCliOrConfig)(args[0]);
    (0, log_info_for_missing_sheriff_config_1.logInfoForMissingSheriffConfig)(projectInfo);
    for (const { fileInfo } of (0, traverse_file_info_1.traverseFileInfo)(projectInfo.fileInfo)) {
        const encapsulations = Object.keys((0, has_encapsulation_violations_1.hasEncapsulationViolations)(fileInfo.path, projectInfo));
        const dependencyRuleViolations = (0, check_for_dependency_rule_violation_1.checkForDependencyRuleViolation)(fileInfo.path, projectInfo);
        if (encapsulations.length > 0 || dependencyRuleViolations.length > 0) {
            hasError = true;
            filesCount++;
            deepImportsCount += encapsulations.length;
            dependencyRulesCount += dependencyRuleViolations.length;
            const dependencyRules = dependencyRuleViolations.map((violation) => `from tag ${violation.fromTag} to tags ${violation.toTags.join(', ')}`);
            validationsMap[fs.relativeTo(fs.cwd(), fileInfo.path)] = {
                encapsulations,
                dependencyRules,
            };
        }
    }
    cli_1.cli.log('');
    cli_1.cli.log(cli_1.cli.bold('Verification Report'));
    if (hasError) {
        cli_1.cli.log('');
        cli_1.cli.log('Issues found:');
        cli_1.cli.log(`  Total Invalid Files: ${filesCount}`);
        cli_1.cli.log(`  Total Encapsulation Violations: ${deepImportsCount}`);
        cli_1.cli.log(`  Total Dependency Rule Violations: ${dependencyRulesCount}`);
        cli_1.cli.log('----------------------------------');
        cli_1.cli.log('');
    }
    else {
        cli_1.cli.log('');
        cli_1.cli.log('\u001b[32mNo issues found. Well done!\u001b[0m');
        cli_1.cli.endProcessOk();
    }
    for (const [file, { encapsulations, dependencyRules }] of Object.entries(validationsMap)) {
        cli_1.cli.log('|-- ' + file);
        if (encapsulations.length > 0) {
            cli_1.cli.log('|   |-- Encapsulation Violations');
            encapsulations.forEach((encapsulation) => {
                cli_1.cli.log('|   |   |-- ' + encapsulation);
            });
        }
        if (dependencyRules.length > 0) {
            cli_1.cli.log('|   |-- Dependency Rule Violations');
            dependencyRules.forEach((dependencyRule) => {
                cli_1.cli.log('|   |   |-- ' + dependencyRule);
            });
        }
    }
    cli_1.cli.endProcessError();
}
//# sourceMappingURL=verify.js.map