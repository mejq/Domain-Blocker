"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkForDependencyRuleViolation = checkForDependencyRuleViolation;
const fs_path_1 = require("../file-info/fs-path");
const calc_tags_for_module_1 = require("../tags/calc-tags-for-module");
const is_dependency_allowed_1 = require("./is-dependency-allowed");
function checkForDependencyRuleViolation(fsPath, { config, getFileInfo, rootDir }) {
    const violations = [];
    if (config.isConfigFileMissing) {
        return [];
    }
    const assignedFileInfo = getFileInfo(fsPath);
    const importedModulePathsWithRawImport = assignedFileInfo.imports
        // skip imports of same module
        .filter((importedFi) => importedFi.moduleInfo.path !== assignedFileInfo.moduleInfo.path)
        .map((fileInfo) => [
        fileInfo.moduleInfo.path,
        assignedFileInfo.getRawImportForImportedFileInfo(fileInfo.path),
    ]);
    const fromModule = (0, fs_path_1.toFsPath)(assignedFileInfo.moduleInfo.path);
    const fromTags = (0, calc_tags_for_module_1.calcTagsForModule)(fromModule, rootDir, config.modules, config.autoTagging);
    for (const [importedModulePath, rawImport,] of importedModulePathsWithRawImport) {
        for (const fromTag of fromTags) {
            const toTags = (0, calc_tags_for_module_1.calcTagsForModule)((0, fs_path_1.toFsPath)(importedModulePath), rootDir, config.modules, config.autoTagging);
            const isViolation = !(0, is_dependency_allowed_1.isDependencyAllowed)(fromTag, toTags, config.depRules, {
                fromModulePath: fromModule,
                toModulePath: (0, fs_path_1.toFsPath)(importedModulePath),
                fromFilePath: fsPath,
                toFilePath: (0, fs_path_1.toFsPath)(importedModulePath),
            });
            if (isViolation) {
                violations.push({
                    rawImport,
                    fromModulePath: fromModule,
                    toModulePath: (0, fs_path_1.toFsPath)(importedModulePath),
                    fromTag,
                    toTags,
                });
                break;
            }
        }
    }
    return violations;
}
//# sourceMappingURL=check-for-dependency-rule-violation.js.map